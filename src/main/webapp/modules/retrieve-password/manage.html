<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>玺颂科技·智慧商场一体化管理平台 - 找回密码</title>
	<link href="img/favicon.ico?${.now?string('yyMMddhhmmSSsss')}" rel="shortcut icon">
    <link href="css/bootstrap.min.css?v=3.4.0" rel="stylesheet">
    <link href="css/font-awesome.min.css?v=4.3.0" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/login.css" rel="stylesheet">
    <style>
    	body {
    		background: #f8f8f8;
    	}
    	.retrieve-password .containPanel {
    		display: inline-block;
    		width: 1000px;
    	}
    	.retrieve-password .left {
    		float: left;
    	}
    	.retrieve-password .header {
    		background: #ffffff;
    		padding: 13px 0;
    	}
    	.retrieve-password .header .logo {
    		height: 43px;
    		width: 43px;
    		background-image: url(img/logo.png)
    	}
    	.retrieve-password .header p{
    		margin: 0;
    		padding: 0 20px;
    		line-height: 44px;
    	}
    	.retrieve-password .header p.title {
    		padding-left: 10px;
    		font-size: 22px;
    		color: #333333;
    		border-right: 1px solid #999999;
    	}
    	.retrieve-password .main .containPanel {
    		height: 500px;
    		margin-top: 40px;
    		background: #ffffff;
    	}
    	.retrieve-password .main .containPanel .above,
    	.retrieve-password .main .containPanel .below {
    		padding: 0 40px;
    	}
    	.retrieve-password .main .containPanel .above {
    		position: relative;
    	}
    	.retrieve-password .containPanel .containPanel-title{
    		margin: 10px 0 0 0;
    		line-height: 50px;
    		border-bottom: 1px solid #dddddd;
    	}
    	.retrieve-password .form-container form,
    	.retrieve-password .go-login-page {
    		display: inline-block;
    		width: 400px;
    		margin-top: 50px;
    		padding: 0 20px;
    	}
    	.retrieve-password .form-container form  .form-group {
    		margin-bottom: 20px;
    	}
    	.retrieve-password .form-container form input {
    		height: 45px;
    		background: #ffffff;
    		border: 1px solid #DAE2EA;
    		border-radius: 4px;
    	}
    	.retrieve-password .codeParent,
    	.retrieve-password .mobile-code {
			position: relative;
		}
		.retrieve-password .codeParent input,
		.retrieve-password .mobile-code input {
			display: inline-block!important;
    		width: 230px!important;
		}
		.retrieve-password .mobile-code .btn {
			position: absolute;
			top: 0;
			right: 0;
			width: 120px;
			background: rgba(245,247,250,1);
			color: #333333;
			border: 1px solid #DAE2EA;
		}
		.retrieve-password #validateCode {
			height: 45px;
		    width: 120px;
		    margin-top: 0px;
		    position: absolute;
			top: 0;
			right: 0
		}
		.retrieve-password .btn {
			height: 45px;
			line-height: 35px;
			background: #18A4FC;
			color: #ffffff;
			font-size: 16px;
		}
		.retrieve-password form .btn {
			width: 170px;
		}
		.retrieve-password form .btn-group .btn:nth-child(2) {
			margin-left: 20px;
		}
		.go-login-page .above {
			margin: 100px 0 65px 0;
		}
		.go-login-page .above p{
			display: inline-block;
			height: 50px;
			padding-left: 60px;
			background: url(img/retrieve-password/success.png) no-repeat 0 0;
			background-size: 50px 50px;
			line-height: 50px;
			font-size: 24px;
			color: #333333;
		}
		.go-login-page .btn {
			margin-top: 40px;
			width: 180px;
		}
		.codeParent label.error,
		.mobile-code label.error{
			display: block!important;
		}
		
    </style>
</head>
<body auto-flag="retrieve-password-page">
	<div class="row retrieve-password" id="retrieve-password">
		<div class="col-sm-12 header text-center">
			<div class="containPanel">
				<i class="img-icon logo left"></i>
				<p class="title left">智慧商场一体化管理平台</p>
				<p class="name left">找回密码</p>
			</div>
		</div>
	    <div class="col-sm-12 main text-center">
	        <div class="containPanel">
	        	<div class="step-1">
	        		<div class="above">
						<p class="containPanel-title text-left">请输入您要找回密码的账号</p>
					</div>
					<div class="below form-container text-center">
						<form autocomplete="off">
							<div class="form-group text-left">
						    	<input class="form-control" type="text" placeholder="请输入手机号码" name="mobile" value="">
							</div>
							<div class="form-group codeParent text-left" >
						    	<input class="form-control" type="text" placeholder="请输入计算结果" name="code">
								<img id="validateCode"/>
					    	</div>
					    	<div class="form-group btn-group" >
					        	<button class="btn next-step">下一步</button>
					        	<a class="btn cancel">取消</a>
					    	</div>
						</form>
						<div class="tip">提示：如果您手机不可使用，请您联系平台管理人员重置密码。</div>
					</div>
	        	</div>
	        	<div class="step-2">
	        		<div class="above">
						<p class="containPanel-title text-left">请输入您要找回密码的账号</p>
					</div>
					<div class="below form-container text-center">
						<form autocomplete="off">
							<div class="form-group text-left">
						    	<input class="form-control newPassword" type="password" placeholder="请输入新密码" name="newPassword">
							</div>
							<div class="form-group text-left" >
						    	<input class="form-control" type="password" placeholder="请再次确认您的密码" name="newPasswordRepeat">
							</div>
							<div class="form-group mobile-code text-left" >
						    	<input class="form-control" type="text" placeholder="请输入短信验证码" name="mobileCode">
								<a class="btn get-mobile-code">获取验证码</a>
					    	</div>
					    	<div class="form-group btn-group">
					        	<a class="btn prev-step">上一步</a>
					        	<button class="btn next-step">下一步</button>
					    	</div>
						</form>
						<div class="tip">提示：如果您手机不可使用，请您联系平台管理人员重置密码。</div>
					</div>
	        	</div>
	        </div>
	    </div>
	</div>
</body>

<script id="go_login_page_tpl" type="text/html">
<div class="go-login-page">
	<div class="above">
		<p>修改成功</p>
	</div>
	<p class="timeNum" style="color:#999999;">10秒后返回登录界面</p>
	<button class="btn">立即登录</button>
</div>
</script>
<script src="js/jquery-2.1.1.min.js"></script>
<script src="js/bootstrap.min.js?v=3.4.0"></script>
<script src="js/plugins/validate/jquery.validate.min.js"></script>
<script src="${base}js/plugins/validate/validate_method.js"></script>
<script src="js/plugins/layer/layer.min.js"></script>
<script src="${base}js/plugins/layui/layui.js" ></script>
<script src="js/jquery.md5.js"></script>
<script src="js/$http.js"></script>
<script>
$(function(){
	/*
	 * layer模板引擎
	 */
	var laytpl = null;

	layui.use([ 'laytpl'], function() {
		laytpl = layui.laytpl;
		RetrievePasswordManage.init();
	});

	var icon = "<i class='fa fa-times-circle'></i> ";
	var Validate = function (id, url, eventBinds) {
        this.id = id;
        this.jq = $("#" + id);
        this.url = url;
        this.config = {width: 120, height: 300};
        this.sequence = "";
        this.createSequence = function () {
            return "retrieve-password-" + new Date().getTime() + "-" + Math.random().toString(36).substr(2);
        };
        this.init = function () {
            var _config = {
                width: 80,
                height: 30,
                fontName:"华文彩云"
            };
            $.extend(this.config, _config);
            var _this = this;
            var length = eventBinds.length;
            for (var j = 0; j < length; j++) {
                this.jq.on(eventBinds[j], function () {
                    _this.request();
                });
            }
            this.request();
            return this;
        };
        this.request = function () {
            this.sequence = this.createSequence();
            this.handlerSrc(this.createUrl());
        };
        this.handlerSrc = function (url) {
            console.info("当前验证码访问路径:url=" + encodeURI(url));
            this.jq.attr("src", encodeURI(url));
        };
        this.createUrl = function () {
            return url + "?sequence=" + this.sequence
                + "&fontName="+this.config.fontName
                + "&width="+this.config.width
                + "&height="+this.config.height
                + "&expire = " + 60 * 1000 * 3
                +"&"+ new Date().getTime();
        };
        this.getCurSequence =function(){
            return this.sequence;
        }
        return this.init();
    }
	
	var RetrievePasswordManage = (function(){
		let moduleId = "#retrieve-password",
			view = $(moduleId + ' .main .containPanel'),
			mobile = '18700000000',
			sequence = {},
			userId = '',
			timer = null,
			timeNumber = 0;
		let init =  function(){
			mobilePanelInit()
		},
		//手机号码的面板初始化
		mobilePanelInit = function(){
			$(moduleId + ' .step-1').fadeIn();
			$(moduleId + ' .step-2').hide();
			var validate = new Validate("validateCode", "/getValidImg", ["click"]),
				panelEl = $(moduleId + ' .step-1');
			panelEl.find('.cancel').unbind().on('click',function(){
				window.location.replace("/login");
			})
			panelEl.find("form").validate({
		        rules: {
		        	mobile: {
		                required: true,
		                phone: true 
		            },
		            code:{
		                required: true
		            }
		        },
		        messages: {
		        	mobile: {
		                required: icon + '请输入手机号码',
		                phone: icon + '请填写11位有效的手机号码'
		                
		            },
		            code:{
		            	required: icon + '请填写验证码',
		            }
		        },
		        submitHandler:function(form){
		        	var data = panelEl.find("form").serializeObject();
		        	var url = '/findPersonByMobile';
		        	data.sequence = validate.sequence;
		        	panelEl.find("form")
		        	loading = layer.load();
		        	$http.get({data:data,url:url},function(res){
		        		console.log(res)
		        		if(res.success) {
		        			if(res.result == null) {
		        				layer.msg('用户不存在',{icon:5})
		        				return false;
		        			}else if(res.result['delete']) {
		        				layer.msg('用户被删除',{icon:5})
		        				return false;
		        			} else if(res.result.enable) {
		        				layer.msg('用户被被禁用',{icon:5})
		        				return false;
		        			}
		        			mobile = res.result.mobile;
		        			userId = res.result.id;
		        			showPasswordPanel();
		        		} else {
		        			layer.msg(res.message,{icon:5});
		        			panelEl.find('#validateCode').trigger('click');
		        		}
		        	})
		        }     
		    });
		},
		//显示输入手机号码的面板
		showPasswordPanel = function(){
			let panelEl = $(moduleId + ' .step-2');
			$(moduleId + ' .step-1').fadeOut(function(){
				panelEl.fadeIn();
			});
			panelEl.find('.containPanel-title').html('您正在找回账号' + mobile + '的密码');
			panelEl.find("form").validate({
				rules: {
					newPassword: {
						required: true,
						passwordR:true,
						rangelength:[6,16]
					},
					newPasswordRepeat: {
						equalTo: '#retrieve-password .newPassword'
					},
					mobileCode: {
						required: true
					},
				},
				messages: {
					newPassword: {
						required: icon + "请输入新密码",
						passwordR:icon+'密码由英文字母、数字、英文符号组成',
						rangelength: icon + "密码长度为6-16"
					},
					newPasswordRepeat: {
						equalTo: icon + "两次输入的密码不一致"
					},
					mobileCode: {
						required: icon + "请输短信验证码",
					},
				},
		        submitHandler:function(form){
		        	var data = $(form).serializeObject();
		        	var url = "/resetPasswdByMobile";
		        	
		        	data.newPassword = $.md5(data.newPassword)
		        	data.mobile = mobile
		            data.sequence = sequence.sms;
		        	loading = layer.load();
		        	
		        	$http.get({data:data,url:url},function(res){
		        		if(res.success) {
		        			panelEl.fadeOut(function(){
				        		showSuccessPanel();
							});
		        		} else {
		        			layer.msg(res.message,{icon:5});
		        		}
		        	})
		        }     
		    });
			panelEl.find('.prev-step').unbind().on('click',function(){
				panelEl.fadeOut(function(){
					$(moduleId + ' .step-1').fadeIn();
					timeNumber = 0;
				});
			})
			panelEl.find('.get-mobile-code').unbind().on('click',function(){
				let self = $(this);
				if(timeNumber > 0) {
	        		return false;
	        	} else {
	        		timeNumber = 60;
	        		getMobileCode();
	        		timer = setInterval(function(){
	        			setBtnName(self,timer)
	        		},1000)
	        		
	        	}
	        	function setBtnName(el,timer)  {
	        		if(timeNumber > 0) {
	        			timeNumber -= 1;
	        			el.html(timeNumber + '秒');
	        			el.attr('disabled','disabled')
	        		} else {
	        			el.html('获取验证码');
	        			el.removeAttr('disabled');
	        			clearInterval(timer);
	        			timer = null;
	        			
	        		}
	        	}
				
			})
			
			
		},
		//显示完成密码重置的界面;
		showSuccessPanel = function(){
			let tpl = go_login_page_tpl.innerHTML;
			laytpl(tpl).render({}, function(html){
				view.html(html);
				view.find('.btn').unbind().on('click',goLogin);
				timeNumber = 10;
				clearInterval(timer);
				timer = setInterval(function(){
        			setBtnName(view.find('.timeNum'),timer);
        		},1000)
        		
        	
	        	function setBtnName(el,timer)  {
	        		if(timeNumber > 0) {
	        			timeNumber -= 1;
	        			el.html(timeNumber + '秒后返回登录界面');
	        			el.attr('disabled','disabled')
	        		} else {
	        			clearInterval(timer);
	        			timer = null;
	        			goLogin();
	        		}
	        	}
			
			})
		},
		getMobileCode = function(){
			var url = '/getMobileCode',
				data = {},
				extendParams = {channel:"clwh",smsTemplate:"当前密码重置的短信验证码:$CODE$"};
        	
        	extendParams.mobile = mobile;
        	sequence.sms = getSequence();
        	data.sequence = sequence.sms;
        	data.extendParams = JSON.stringify(extendParams);
        	timeNumber = 60;
        	$http.get({data:data,url:url},function(res){
        		console.log(res,timeNumber)
        		if(!res.success) {
        			layer.msg(res.message,{icon:5})
        		}
        	})
		},
		goLogin = function(){
			window.location.replace("/login");
		},
		getSequence = function(){
			return "retrieve-password-" + new Date().getTime() + "-" + Math.random().toString(36).substr(2);
		};
		$.validator.addMethod("passwordR",function(value,element,params){  
			var passwordR = /^[a-zA-Z\d~\!@#\$%\^&\*\(\)_\-\+=\{\[\}\]\|\\:;\"\'\<,\>\.\?\/]+$/;
			return this.optional(element)||(passwordR.test(value));  
		},"*密码格式错误");
		return {
			init: init
		}
	}())
	$.fn.serializeObject = function(){
	   var o = {};
	   var a = this.serializeArray();
	   $.each(a, function() {
	       if (o[this.name]) {
	           if (!o[this.name].push) {
	               o[this.name] = [o[this.name]];
	           }
	           o[this.name].push(this.value || '');
	       } else {
	           o[this.name] = this.value || '';
	       }
	   });
	   return o;
	};
		
	
	
})
</script>
</html>
